<!DOCTYPE html>
<html>
<head>
  <title>Rede LSTM Mega Sena</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
</head>
<body>
  <h2>Previs√£o de Dezenas - Rede LSTM</h2>
  <input type="file" id="fileInput" />
  <button onclick="treinar()">Treinar e Prever</button>
  <pre id="output"></pre>

  <script>
    let dados = [];

    document.getElementById("fileInput").addEventListener("change", function(evt) {
      const file = evt.target.files[0];
      const reader = new FileReader();
      reader.onload = function(e) {
        const linhas = e.target.result.trim().split("\n").slice(1);
        dados = linhas.map(linha => linha.split(",").map(Number));
        document.getElementById("output").textContent = "CSV carregado com " + dados.length + " sorteios.";
      };
      reader.readAsText(file);
    });

    function extrairFeatures(seq) {
      // seq √© array com 6 dezenas do sorteio
      // Exemplo simples: normaliza e conta pares
      const normalizados = seq.map(n => n / 60);
      const pares = seq.filter(n => n % 2 === 0).length / 6; // fra√ß√£o pares
      const somaNorm = seq.reduce((a,b) => a+b, 0) / (6*60); // soma normalizada
      return [...normalizados, pares, somaNorm]; // 6 + 2 features = 8 por sorteio
    }

    async function treinar() {
      if (dados.length < 10) return alert("Carregue um CSV com sorteios primeiro!");

      const entradas = [];
      const saidas = [];

      for (let i = 5; i < dados.length; i++) {
        // Sequ√™ncia dos √∫ltimos 5 sorteios, extraindo features
        const seq = [];
        for(let j = i-5; j < i; j++) {
          seq.push(extrairFeatures(dados[j]));
        }
        entradas.push(seq);
        // sa√≠da √© o pr√≥ximo sorteio, normalizado entre 0 e 1
        saidas.push(dados[i].map(n => n / 60));
      }

      // Tensor 3D: [amostras, tempo, features]
      const xs = tf.tensor3d(entradas);
      // Tensor 2D sa√≠da: [amostras, 6]
      const ys = tf.tensor2d(saidas);

      // Modelo LSTM
      const model = tf.sequential();
      model.add(tf.layers.lstm({
        inputShape: [5, 8], // 5 sorteios, 8 features
        units: 64,
        returnSequences: false
      }));
      model.add(tf.layers.dense({units: 32, activation: 'relu'}));
      model.add(tf.layers.dense({units: 6, activation: 'sigmoid'}));

      model.compile({optimizer: 'adam', loss: 'meanSquaredError'});

      document.getElementById("output").textContent += "\nTreinando...";

      await model.fit(xs, ys, {
        epochs: 200,
        batchSize: 16,
        callbacks: {
          onEpochEnd: (epoch, logs) => {
            if (epoch % 20 === 0) {
              document.getElementById("output").textContent += `\n√âpoca ${epoch}, erro: ${logs.loss.toFixed(6)}`;
            }
          }
        }
      });

      // Previs√£o
      const ultimaSeq = [];
      for(let j = dados.length - 5; j < dados.length; j++) {
        ultimaSeq.push(extrairFeatures(dados[j]));
      }
      const input = tf.tensor3d([ultimaSeq]);
      const output = model.predict(input);
      const numeros = Array.from(output.dataSync()).map(v => Math.round(v * 60));

      // Remove duplicados e garante 6 n√∫meros
      const unicosSet = new Set(numeros);
      while (unicosSet.size < 6) {
        unicosSet.add(Math.floor(Math.random() * 60) + 1);
      }
      const unicos = Array.from(unicosSet).slice(0, 6).sort((a, b) => a - b);

      document.getElementById("output").textContent += `\n\nüîÆ Previs√£o de dezenas:\n${unicos.join(", ")}`;
    }
  </script>
</body>
</html>
